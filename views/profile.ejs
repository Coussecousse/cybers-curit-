<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h2>MonApplication</h2>
            <div class="nav-links">
                <a href="/dashboard">Tableau de bord</a>
                <a href="/profile" class="active">Profil</a>
                <a href="/logout" class="btn-logout">Déconnexion</a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="content-box">
            <h1>Mon Profil</h1>
            
            <% if (success) { %>
                <div class="alert alert-success"><%= success %></div>
            <% } %>
            
            <% if (error) { %>
                <div class="alert alert-error"><%= error %></div>
            <% } %>
            
            <div class="info-card">
                <h3>Informations personnelles</h3>
                <p><strong>Nom d'utilisateur :</strong> <%= user.username %></p>
                <p><strong>Email :</strong> <%= user.email %></p>
            </div>
            
            <div class="info-card">
                <h3>Double Authentification (2FA)</h3>
                <p><strong>Statut :</strong> 
                    <% if (user.two_factor_enabled) { %>
                        <span class="badge badge-success">Activé ✓</span>
                    <% } else { %>
                        <span class="badge badge-warning">Désactivé</span>
                    <% } %>
                </p>
                
                <% if (!user.two_factor_enabled) { %>
                    <p class="text-muted">La double authentification ajoute une couche de sécurité supplémentaire à votre compte.</p>
                    
                    <% if (!qrCode) { %>
                        <form action="/profile/enable-2fa" method="POST">
                            <button type="submit" class="btn btn-primary">Activer la double authentification</button>
                        </form>
                    <% } %>
                <% } else { %>
                    <p class="text-success">Votre compte est protégé par la double authentification.</p>
                    
                    <% if (typeof showDisable2FAForm !== 'undefined' && showDisable2FAForm) { %>
                        <div class="disable-2fa-form" style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107;">
                            <h4 style="color: #856404; margin-bottom: 0.5rem;">⚠️ Confirmation requise</h4>
                            <p style="color: #856404; margin-bottom: 1rem;">Pour des raisons de sécurité, veuillez entrer votre code d'authentification pour désactiver le 2FA.</p>
                            <form action="/profile/disable-2fa" method="POST">
                                <div class="form-group">
                                    <label for="disable-code">Code de vérification</label>
                                    <input type="text" id="disable-code" name="code" required 
                                           pattern="[0-9A-Za-z]{6,20}" 
                                           maxlength="20"
                                           placeholder="Code à 6 chiffres ou code de secours"
                                           class="otp-input"
                                           autocomplete="off">
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button type="submit" class="btn btn-danger">Confirmer la désactivation</button>
                                    <button type="button" class="btn btn-secondary" onclick="window.location.reload()">Annuler</button>
                                </div>
                            </form>
                        </div>
                    <% } else { %>
                        <form action="/profile/disable-2fa" method="POST">
                            <button type="submit" class="btn btn-danger">Désactiver la double authentification</button>
                        </form>
                    <% } %>
                <% } %>
            </div>
            
            <% if (qrCode) { %>
                <div class="info-card qr-code-section">
                    <h3>Configuration de la double authentification</h3>
                    
                    <div class="steps">
                        <div class="step">
                            <h4>Étape 1 : Scannez le QR Code</h4>
                            <p>Utilisez une application d'authentification (Google Authenticator, Authy, Microsoft Authenticator, etc.) pour scanner ce code QR :</p>
                            <div class="qr-code-container">
                                <img src="<%= qrCode %>" alt="QR Code 2FA">
                            </div>
                            <p class="text-muted">Ou entrez manuellement cette clé : <code><%= secret %></code></p>
                        </div>
                        
                        <div class="step">
                            <h4>Étape 2 : Entrez le code de vérification</h4>
                            <p>Entrez le code à 6 chiffres généré par votre application pour activer la double authentification :</p>
                            <form action="/profile/validate-2fa" method="POST">
                                <div class="form-group">
                                    <input type="text" id="code" name="code" required 
                                           pattern="[0-9]{6}" 
                                           maxlength="6" 
                                           placeholder="000000"
                                           class="otp-input"
                                           autocomplete="off">
                                </div>
                                <button type="submit" class="btn btn-success">Valider et activer</button>
                            </form>
                        </div>
                    </div>
                </div>
            <% } %>
            
            <% if (backupCodes && backupCodes.length > 0) { %>
                <div class="info-card backup-codes-section">
                    <h3>⚠️ Codes de secours</h3>
                    <p class="alert alert-warning">
                        <strong>Important !</strong> Sauvegardez ces codes de secours dans un endroit sûr. 
                        Vous pourrez les utiliser si vous perdez l'accès à votre application d'authentification.
                        Chaque code ne peut être utilisé qu'une seule fois.
                    </p>
                    
                    <div class="backup-codes-grid">
                        <% backupCodes.forEach(function(code, index) { %>
                            <div class="backup-code">
                                <span class="code-number"><%= index + 1 %>.</span>
                                <code><%= code %></code>
                            </div>
                        <% }); %>
                    </div>
                    
                    <div class="backup-actions">
                        <button onclick="printBackupCodes()" class="btn btn-secondary">Imprimer</button>
                        <button onclick="copyBackupCodes()" class="btn btn-secondary">Copier tous</button>
                    </div>
                </div>
                
                <script>
                    function printBackupCodes() {
                        window.print();
                    }
                    
                    function copyBackupCodes() {
                        const codes = <%- JSON.stringify(backupCodes) %>;
                        const text = codes.join('\n');
                        navigator.clipboard.writeText(text).then(() => {
                            alert('Codes de secours copiés dans le presse-papier !');
                        });
                    }
                </script>
            <% } %>
        </div>
    </div>
</body>
</html>
